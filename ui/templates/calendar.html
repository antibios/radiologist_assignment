{{ define "content" }}
<div class="container">
    <div class="row">
        <div class="col max">
            <h4>Calendar - {{ .ViewName }}</h4>
        </div>
        <div class="col min">
            <a href="?view=month" class="button {{ if eq .View "month" }}primary{{ else }}transparent{{ end }}">Month</a>
            <a href="?view=week" class="button {{ if eq .View "week" }}primary{{ else }}transparent{{ end }}">Week</a>
            <a href="?view=day" class="button {{ if eq .View "day" }}primary{{ else }}transparent{{ end }}">Day</a>
        </div>
    </div>

    {{ if eq .View "month" }}
        <!-- Month Header (Grid) -->
        <div class="calendar-month-grid calendar-header margin-bottom">
            <div class="center-align bold">Mon</div>
            <div class="center-align bold">Tue</div>
            <div class="center-align bold">Wed</div>
            <div class="center-align bold">Thu</div>
            <div class="center-align bold">Fri</div>
            <div class="center-align bold">Sat</div>
            <div class="center-align bold">Sun</div>
        </div>

        <div class="calendar-month-grid">
            {{ range .Days }}
            <!-- Link to Day View -->
            <a href="?view=day&date={{.Date.Format "2006-01-02"}}" class="calendar-day-card border round padding hover">
                <div class="row no-space">
                    <div class="col max">
                        <h6 class="no-margin">{{ .Date.Format "02" }}</h6>
                    </div>
                    <div class="col min">
                         <span class="tiny-text">{{ .Date.Format "Mon" }}</span>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="row no-space">
                        <div class="col max tiny-text">Scheduled:</div>
                        <div class="col min bold">{{ .Stats.TotalShifts }}</div>
                    </div>
                    <div class="row no-space">
                        <div class="col max tiny-text green-text">Filled:</div>
                        <div class="col min bold green-text">{{ .Stats.FilledShifts }}</div>
                    </div>
                    <div class="row no-space">
                        <div class="col max tiny-text red-text">Unfilled:</div>
                        <div class="col min bold red-text">{{ .Stats.UnfilledShifts }}</div>
                    </div>
                    <div class="divider"></div>
                    <div class="row no-space">
                        <div class="col max tiny-text">Radiologists:</div>
                        <div class="col min bold">{{ .Stats.RosteredRadiologists }}</div>
                    </div>
                </div>
            </a>
            {{ end }}
        </div>
    {{ else }}
        <!-- Overview / Unfilled Shifts -->
        <article class="border warning-container">
            <h5>Unfilled Shifts Overview</h5>
            <div class="row">
                {{ range .UnfilledShifts }}
                <div class="col s12 m6 l4">
                    <div class="chip error pointer" onclick='openRosterModal({{.ShiftID}}, "{{.ShiftName}}", "{{.Date.Format "2006-01-02"}}", {{json .AssignedRadiologistIDs}})'>
                        <i>warning</i>
                        <span>{{ .Date.Format "Jan 02" }}: {{ .ShiftName }}</span>
                    </div>
                </div>
                {{ else }}
                <div class="col s12">
                    <p>All shifts are covered for the current view!</p>
                </div>
                {{ end }}
            </div>
        </article>

        <!-- Week/Day List View -->
        <table class="stripes">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Shift</th>
                    <th>Work Type</th>
                    <th>Status</th>
                    <th>Assigned To</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {{ range .Days }}
                    {{ $date := .Date }}
                    {{ range .Shifts }}
                    <tr>
                        <td>{{ $date.Format "Mon, Jan 02" }}</td>
                        <td>{{ .ShiftName }}</td>
                        <td>{{ .ShiftType }}</td>
                        <td>
                            {{ if .Filled }}
                            <span class="badge green">Filled</span>
                            {{ else }}
                            <span class="badge red">Unfilled</span>
                            {{ end }}
                        </td>
                        <td>
                            {{ range .RadiologistNames }}
                            <div class="chip small secondary">{{.}}</div>
                            {{ end }}
                        </td>
                        <td>
                            <button class="circle transparent small" onclick='openRosterModal({{.ShiftID}}, "{{.ShiftName}}", "{{.Date.Format "2006-01-02"}}", {{json .AssignedRadiologistIDs}})'>
                                <i>edit</i>
                            </button>
                        </td>
                    </tr>
                    {{ end }}
                {{ end }}
            </tbody>
        </table>
    {{ end }}
</div>

<!-- Manage Roster Modal -->
<dialog id="manage-roster-modal">
    <h5>Manage Roster</h5>
    <p>
        <strong>Shift:</strong> <span id="roster-shift-name"></span><br>
        <strong>Date:</strong> <span id="roster-date-display"></span>
    </p>
    <form action="/api/shifts/assign" method="POST">
        <input type="hidden" name="shift_id" id="roster-shift-id">
        <input type="hidden" name="date" id="roster-date">

        <fieldset>
            <legend>Assigned Radiologists</legend>
            <nav class="vertical" style="max-height: 300px; overflow-y: auto;">
                {{ range .Radiologists }}
                <label class="checkbox">
                    <input type="checkbox" name="radiologist_ids" value="{{.ID}}" id="rad-{{.ID}}">
                    <span>{{.FirstName}} {{.LastName}}</span>
                </label>
                {{ end }}
            </nav>
        </fieldset>

        <nav class="right-align">
            <button type="button" class="transparent link" onclick="ui('#manage-roster-modal')">Cancel</button>
            <button type="submit" class="primary">Save Assignment</button>
        </nav>
    </form>
</dialog>

<script>
    function openRosterModal(shiftID, shiftName, date, assignedIDs) {
        document.getElementById('roster-shift-id').value = shiftID;
        document.getElementById('roster-date').value = date;
        document.getElementById('roster-shift-name').innerText = shiftName;
        document.getElementById('roster-date-display').innerText = date;

        // Reset all checkboxes
        const inputs = document.querySelectorAll('#manage-roster-modal input[type="checkbox"]');
        inputs.forEach(input => input.checked = false);

        // Check assigned
        if (assignedIDs) {
            if (typeof assignedIDs === 'string') {
                try {
                    assignedIDs = JSON.parse(assignedIDs);
                } catch (e) {
                    console.error("Failed to parse assignedIDs", e);
                    assignedIDs = [];
                }
            }
            if (Array.isArray(assignedIDs)) {
                assignedIDs.forEach(id => {
                    const el = document.getElementById('rad-' + id);
                    if (el) el.checked = true;
                });
            }
        }

        ui('#manage-roster-modal');
    }
</script>

<style>
    /* Custom Grid for Calendar Month View */
    .calendar-month-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
    }

    .calendar-day-card {
        display: block;
        color: inherit;
        text-decoration: none;
        transition: background-color 0.2s;
    }

    .calendar-day-card:hover {
        background-color: var(--surface-container-high);
    }

    .stats-container {
        margin-top: 8px;
    }

    .tiny-text { font-size: 0.75rem; }
    .pointer { cursor: pointer; }

    /* Responsive: Mobile - 1 column */
    @media only screen and (max-width: 600px) {
        .calendar-month-grid {
            grid-template-columns: 1fr;
        }
        .calendar-header {
            display: none;
        }
    }
</style>
{{ end }}
