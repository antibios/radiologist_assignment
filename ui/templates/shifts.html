{{ define "content" }}
<div class="container">
    <div class="row">
        <div class="col max">
            <h4>Shift Management</h4>
        </div>
        <div class="col min">
            <button class="primary" onclick="ui('#add-shift-modal')">
                <i>add</i>
                <span>Add Shift</span>
            </button>
        </div>
    </div>

    <table class="stripes">
        <thead>
            <tr>
                <th>Priority</th>
                <th>Name</th>
                <th>Work Type</th>
                <th>Strategy</th>
                <th>Sites</th>
                <th>Credentials</th>
                <th>Preferred</th>
                <th>Blocked</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{ range .Shifts }}
            <tr id="shift-row-{{.ID}}">
                <td>{{ .PriorityLevel }}</td>
                <td class="shift-name">{{ .Name }}</td>
                <td>{{ .WorkType }}</td>
                <td>{{ .LoadBalancingStrategy }}</td>
                <td>{{ range .Sites }}{{.}}, {{end}}</td>
                <td>{{ range .RequiredCredentials }}{{.}}, {{end}}</td>
                <td>{{ range .PreferredRadiologistIDs }}<span class="badge min">{{.}}</span>{{end}}</td>
                <td>{{ range .BlockedRadiologistIDs }}<span class="badge min error">{{.}}</span>{{end}}</td>
                <td>
                    <button class="circle transparent small" onclick="openEditShiftModal(this)" data-shift='{{json .}}'>
                        <i>edit</i>
                    </button>
                    <form action="/api/shifts/delete" method="POST" style="display:inline;">
                        <input type="hidden" name="id" value="{{.ID}}">
                        <button class="circle transparent small error-text" type="submit">
                            <i>delete</i>
                        </button>
                    </form>
                </td>
            </tr>
            {{ end }}
        </tbody>
    </table>
</div>

<!-- Add Shift Modal -->
<dialog id="add-shift-modal" class="max">
    <h5>Add New Shift</h5>
    <form action="/api/shifts" method="POST">
        <div class="grid">
            <div class="s12 m6">
                <div class="field label border">
                    <input type="text" name="name" required>
                    <label>Shift Name</label>
                </div>
                <div class="field label border">
                    <select name="work_type">
                        {{ range .Modalities }}
                        <option value="{{.Code}}">{{.Name}}</option>
                        {{ end }}
                    </select>
                    <label>Work Type</label>
                </div>
                <div class="field label border">
                    <input type="number" name="priority" value="0">
                    <label>Priority</label>
                </div>
                <div class="field label border">
                    <select name="load_balancing_strategy">
                        <option value="count">Count (Concurrent Studies)</option>
                        <option value="rvu">RVU (Total RVU)</option>
                    </select>
                    <label>Load Balancing Strategy</label>
                </div>
            </div>
            <div class="s12 m6">
                <fieldset>
                    <legend>Sites</legend>
                    <nav class="vertical" style="max-height: 150px; overflow-y: auto;">
                        {{ range .Sites }}
                        <label class="checkbox">
                            <input type="checkbox" name="sites" value="{{.Code}}">
                            <span>{{.Name}}</span>
                        </label>
                        {{ end }}
                    </nav>
                </fieldset>
                <fieldset>
                    <legend>Required Credentials</legend>
                    <nav class="vertical" style="max-height: 150px; overflow-y: auto;">
                        {{ range .Credentials }}
                        <label class="checkbox">
                            <input type="checkbox" name="credentials" value="{{.Code}}">
                            <span>{{.Name}}</span>
                        </label>
                        {{ end }}
                    </nav>
                </fieldset>
            </div>
            <div class="s12 m6">
                <fieldset>
                    <legend>Preferred Radiologists</legend>
                    <nav class="vertical" style="max-height: 150px; overflow-y: auto;">
                        {{ range .Radiologists }}
                        <label class="checkbox">
                            <input type="checkbox" name="preferred_radiologist_ids" value="{{.ID}}">
                            <span>{{.FirstName}} {{.LastName}}</span>
                        </label>
                        {{ end }}
                    </nav>
                </fieldset>
            </div>
            <div class="s12 m6">
                <fieldset>
                    <legend>Blocked Radiologists</legend>
                    <nav class="vertical" style="max-height: 150px; overflow-y: auto;">
                        {{ range .Radiologists }}
                        <label class="checkbox">
                            <input type="checkbox" name="blocked_radiologist_ids" value="{{.ID}}">
                            <span>{{.FirstName}} {{.LastName}}</span>
                        </label>
                        {{ end }}
                    </nav>
                </fieldset>
            </div>
        </div>
        <nav class="right-align">
            <button type="button" class="transparent link" onclick="ui('#add-shift-modal')">Cancel</button>
            <button type="submit" class="primary">Save Shift</button>
        </nav>
    </form>
</dialog>

<!-- Edit Shift Modal -->
<dialog id="edit-shift-modal" class="max">
    <h5>Edit Shift</h5>
    <form action="/api/shifts/edit" method="POST">
        <input type="hidden" name="id" id="edit-shift-id">
        <div class="grid">
            <div class="s12 m6">
                <div class="field label border">
                    <input type="text" name="name" id="edit-shift-name" required>
                    <label>Shift Name</label>
                </div>
                <div class="field label border">
                    <select name="work_type" id="edit-shift-work-type">
                        {{ range .Modalities }}
                        <option value="{{.Code}}">{{.Name}}</option>
                        {{ end }}
                    </select>
                    <label>Work Type</label>
                </div>
                <div class="field label border">
                    <input type="number" name="priority" id="edit-shift-priority" value="0">
                    <label>Priority</label>
                </div>
                <div class="field label border">
                    <select name="load_balancing_strategy" id="edit-shift-strategy">
                        <option value="count">Count (Concurrent Studies)</option>
                        <option value="rvu">RVU (Total RVU)</option>
                    </select>
                    <label>Load Balancing Strategy</label>
                </div>
            </div>
            <div class="s12 m6">
                <fieldset>
                    <legend>Sites</legend>
                    <nav class="vertical" style="max-height: 150px; overflow-y: auto;" id="edit-shift-sites">
                        {{ range .Sites }}
                        <label class="checkbox">
                            <input type="checkbox" name="sites" value="{{.Code}}">
                            <span>{{.Name}}</span>
                        </label>
                        {{ end }}
                    </nav>
                </fieldset>
                <fieldset>
                    <legend>Required Credentials</legend>
                    <nav class="vertical" style="max-height: 150px; overflow-y: auto;" id="edit-shift-creds">
                        {{ range .Credentials }}
                        <label class="checkbox">
                            <input type="checkbox" name="credentials" value="{{.Code}}">
                            <span>{{.Name}}</span>
                        </label>
                        {{ end }}
                    </nav>
                </fieldset>
            </div>
            <div class="s12 m6">
                <fieldset>
                    <legend>Preferred Radiologists</legend>
                    <nav class="vertical" style="max-height: 150px; overflow-y: auto;" id="edit-shift-preferred">
                        {{ range .Radiologists }}
                        <label class="checkbox">
                            <input type="checkbox" name="preferred_radiologist_ids" value="{{.ID}}">
                            <span>{{.FirstName}} {{.LastName}}</span>
                        </label>
                        {{ end }}
                    </nav>
                </fieldset>
            </div>
            <div class="s12 m6">
                <fieldset>
                    <legend>Blocked Radiologists</legend>
                    <nav class="vertical" style="max-height: 150px; overflow-y: auto;" id="edit-shift-blocked">
                        {{ range .Radiologists }}
                        <label class="checkbox">
                            <input type="checkbox" name="blocked_radiologist_ids" value="{{.ID}}">
                            <span>{{.FirstName}} {{.LastName}}</span>
                        </label>
                        {{ end }}
                    </nav>
                </fieldset>
            </div>
        </div>
        <nav class="right-align">
            <button type="button" class="transparent link" onclick="ui('#edit-shift-modal')">Cancel</button>
            <button type="submit" class="primary">Update Shift</button>
        </nav>
    </form>
</dialog>

<script>
    function openEditShiftModal(btn) {
        const shift = JSON.parse(btn.getAttribute('data-shift'));
        document.getElementById('edit-shift-id').value = shift.id;
        document.getElementById('edit-shift-name').value = shift.name;
        document.getElementById('edit-shift-priority').value = shift.priority_level;

        // Select work type
        const wtSelect = document.getElementById('edit-shift-work-type');
        wtSelect.value = shift.work_type;

        // Select strategy
        const stSelect = document.getElementById('edit-shift-strategy');
        stSelect.value = shift.load_balancing_strategy || "count";

        // Checkboxes helper
        function checkBoxes(containerId, values) {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('input[type="checkbox"]');
            inputs.forEach(input => {
                input.checked = values && values.includes(input.value);
            });
        }

        checkBoxes('edit-shift-sites', shift.sites);
        checkBoxes('edit-shift-creds', shift.required_credentials);
        checkBoxes('edit-shift-preferred', shift.preferred_radiologist_ids);
        checkBoxes('edit-shift-blocked', shift.blocked_radiologist_ids);

        document.getElementById('edit-shift-modal').setAttribute('open', 'true');
    }
</script>
{{ end }}
