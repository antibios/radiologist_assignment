{{ define "content" }}
<div class="container">
    <div class="row">
        <div class="col max">
            <h4>Shift Management</h4>
        </div>
        <div class="col min">
            <button class="primary" onclick="ui('#add-shift-modal')">
                <i>add</i>
                <span>Add Shift</span>
            </button>
        </div>
    </div>

    <table class="stripes">
        <thead>
            <tr>
                <th>Priority</th>
                <th>Name</th>
                <th>Work Type</th>
                <th>Sites</th>
                <th>Credentials</th>
                <th>Roster</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{ $roster := .Roster }}
            {{ range .Shifts }}
            <tr id="shift-row-{{.ID}}">
                <td>{{ .PriorityLevel }}</td>
                <td class="shift-name">{{ .Name }}</td>
                <td>{{ .WorkType }}</td>
                <td>{{ range .Sites }}{{.}}, {{end}}</td>
                <td>{{ range .RequiredCredentials }}{{.}}, {{end}}</td>
                <td class="roster-cell">
                    {{ $entries := index $roster .ID }}
                    {{ range $entries }}
                        <span class="badge secondary">{{ .RadiologistID }}</span>
                    {{ end }}
                    <button class="circle transparent small" onclick="openAssignModal({{.ID}}, '{{.Name}}')">
                        <i>person_add</i>
                    </button>
                </td>
                <td>
                    <button class="circle transparent small" onclick="openEditShiftModal({{.ID}}, '{{.Name}}')">
                        <i>edit</i>
                    </button>
                    <form action="/api/shifts/delete" method="POST" style="display:inline;">
                        <input type="hidden" name="id" value="{{.ID}}">
                        <button class="circle transparent small error-text" type="submit">
                            <i>delete</i>
                        </button>
                    </form>
                </td>
            </tr>
            {{ end }}
        </tbody>
    </table>
</div>

<!-- Add Shift Modal -->
<dialog id="add-shift-modal">
    <h5>Add New Shift</h5>
    <form action="/api/shifts" method="POST">
        <div class="field label border">
            <input type="text" name="name" required>
            <label>Shift Name</label>
        </div>
        <div class="field label border">
            <select name="work_type">
                {{ range .Modalities }}
                <option value="{{.Code}}">{{.Name}}</option>
                {{ end }}
            </select>
            <label>Work Type</label>
        </div>
        <div class="field label border" id="site-search-container" data-signals="{siteSearch: ''}">
            <input type="text" placeholder="Search Site..." data-bind-siteSearch data-on-input__debounce.200ms="@get('/active_search?type=site')">
            <label>Sites</label>
            <div id="site-results"></div>
            <div id="selected-sites-list" class="row">
                <!-- Selected sites will appear here -->
            </div>
        </div>
        <div class="field label border">
            <input type="number" name="priority" value="0">
            <label>Priority</label>
        </div>
        <fieldset>
            <legend>Required Credentials</legend>
            <nav class="vertical" style="max-height: 200px; overflow-y: auto;">
                {{ range .Credentials }}
                <label class="checkbox">
                    <input type="checkbox" name="credentials" value="{{.Code}}">
                    <span>{{.Name}}</span>
                </label>
                {{ end }}
            </nav>
        </fieldset>
        <nav class="right-align">
            <button type="button" class="transparent link" onclick="ui('#add-shift-modal')">Cancel</button>
            <button type="submit" class="primary">Save Shift</button>
        </nav>
    </form>
</dialog>

<!-- Edit Shift Modal -->
<dialog id="edit-shift-modal">
    <h5>Edit Shift</h5>
    <form action="/api/shifts/edit" method="POST">
        <input type="hidden" name="id" id="edit-shift-id">
        <div class="field label border">
            <input type="text" name="name" id="edit-shift-name" required>
            <label>Shift Name</label>
        </div>
        <nav class="right-align">
            <button type="button" class="transparent link" onclick="ui('#edit-shift-modal')">Cancel</button>
            <button type="submit" class="primary">Update Shift</button>
        </nav>
    </form>
</dialog>

<!-- Assign Radiologist Modal -->
<dialog id="assign-rad-modal">
    <h5>Assign Radiologist</h5>
    <form action="/api/shifts/assign" method="POST">
        <input type="hidden" name="shift_id" id="assign-shift-id">
        <p>Assigning to: <span id="assign-shift-name"></span></p>
        <div class="field label border" id="radiologist-search-container" data-signals="{radiologistSearch: ''}">
            <input type="text" placeholder="Search Radiologist..." data-bind-radiologistSearch data-on-input__debounce.200ms="@get('/active_search?type=radiologist')">
            <label>Radiologist</label>
            <div id="radiologist-results"></div>
            <input type="hidden" name="radiologist_id" id="selected-radiologist-id">
            <div id="selected-radiologist-display"></div>
        </div>
        <nav class="right-align">
            <button type="button" class="transparent link" onclick="ui('#assign-rad-modal')">Cancel</button>
            <button type="submit" class="primary">Assign</button>
        </nav>
    </form>
</dialog>

<script>
    function openEditShiftModal(id, name) {
        document.getElementById('edit-shift-id').value = id;
        document.getElementById('edit-shift-name').value = name;
        document.getElementById('edit-shift-modal').setAttribute('open', 'true');
    }

    function openAssignModal(id, name) {
        document.getElementById('assign-shift-id').value = id;
        document.getElementById('assign-shift-name').innerText = name;
        document.getElementById('assign-rad-modal').setAttribute('open', 'true');
    }

    function selectRadiologist(id, name) {
        document.getElementById('selected-radiologist-id').value = id;
        document.getElementById('selected-radiologist-display').innerHTML = `
            <div class="chip">
                <span>${name}</span>
                <i onclick="clearRadiologist()">close</i>
            </div>
        `;
        document.getElementById('radiologist-results').innerHTML = '';
    }

    function clearRadiologist() {
        document.getElementById('selected-radiologist-id').value = '';
        document.getElementById('selected-radiologist-display').innerHTML = '';
    }

    function addSite(code, name) {
        const list = document.getElementById('selected-sites-list');
        if (list.querySelector(`input[value="${code}"]`)) return;

        const div = document.createElement('div');
        div.className = 'chip';
        div.innerHTML = `
            <span>${name}</span>
            <input type="hidden" name="sites" value="${code}">
            <i onclick="this.parentElement.remove()">close</i>
        `;
        list.appendChild(div);
        document.getElementById('site-results').innerHTML = '';
    }
</script>
{{ end }}
