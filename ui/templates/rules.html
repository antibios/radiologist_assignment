{{ define "content" }}
<div class="container">
    <div class="row">
        <div class="col max">
            <h4>Assignment Rules</h4>
        </div>
        <div class="col min">
            <button class="primary" onclick="ui('#add-rule-modal')">
                <i>add</i>
                <span>Add Rule</span>
            </button>
        </div>
    </div>

    <table class="stripes">
        <thead>
            <tr>
                <th>Priority</th>
                <th>Name</th>
                <th>Action Type</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{ range .Rules }}
            <tr id="rule-row-{{.ID}}">
                <td>{{ .PriorityOrder }}</td>
                <td class="rule-name">{{ .Name }}</td>
                <td>{{ .ActionType }}</td>
                <td>
                    {{ if .Enabled }}
                    <span class="badge green">Enabled</span>
                    {{ else }}
                    <span class="badge red">Disabled</span>
                    {{ end }}
                </td>
                <td>
                    <button class="circle transparent small" onclick='openEditModal({{.ID}}, "{{.Name}}", "{{.ActionType}}", "{{.ActionTarget}}", {{json .ConditionFilters}})'>
                        <i>edit</i>
                    </button>
                    <form action="/api/rules/delete" method="POST" style="display:inline;">
                        <input type="hidden" name="id" value="{{.ID}}">
                        <button class="circle transparent small error-text" type="submit">
                            <i>delete</i>
                        </button>
                    </form>
                </td>
            </tr>
            {{ end }}
        </tbody>
    </table>
</div>

<!-- Add Modal -->
<dialog id="add-rule-modal">
    <h5>Add New Rule</h5>
    <form action="/api/rules" method="POST">
        <div class="field label border">
            <input type="text" name="name" required>
            <label>Rule Name</label>
        </div>
        <div class="field label border">
            <select name="action">
                <option value="FILTER_COMPETENCY">Filter Competency</option>
                <option value="ESCALATE">Escalate</option>
                <option value="ASSIGN_TO_SHIFT">Assign to Shift</option>
                <option value="ASSIGN_TO_RADIOLOGIST">Assign to Radiologist</option>
                <option value="ASSIGN_TO_WORKLIST">Assign to Worklist</option>
            </select>
            <label>Action Type</label>
        </div>
        <div class="field label border">
            <input type="text" name="target">
            <label>Action Target (ID, Shift ID, Worklist)</label>
        </div>

        <h6>Criteria</h6>
        <div class="field label border suffix">
            <select id="add-criteria-select-add">
                <option value="" disabled selected>Select Criteria to Add</option>
                <option value="urgency">Exam Priority (Urgency)</option>
                <option value="site">Exam Site Code</option>
                <option value="ordering_physician">Referrer Details</option>
                <option value="patient_age_min">Patient Age (Min)</option>
                <option value="patient_age_max">Patient Age (Max)</option>
                <option value="procedure_code">Procedure Code</option>
                <option value="procedure_description">Procedure Description</option>
                <option value="prior_location">Prior Location</option>
                <option value="days_of_week">Days of Week (comma-sep)</option>
                <option value="technician">Technician</option>
                <option value="transcriptionist">Transcriptionist</option>
            </select>
            <label>Add Condition</label>
            <button type="button" onclick="addCriteria('add')">Add</button>
        </div>
        <div id="criteria-container-add"></div>

        <nav class="right-align">
            <button type="button" class="transparent link" onclick="ui('#add-rule-modal')">Cancel</button>
            <button type="submit" class="primary">Save Rule</button>
        </nav>
    </form>
</dialog>

<!-- Edit Modal -->
<dialog id="edit-rule-modal">
    <h5>Edit Rule</h5>
    <form action="/api/rules/edit" method="POST">
        <input type="hidden" name="id" id="edit-id">
        <div class="field label border">
            <input type="text" name="name" id="edit-name" required>
            <label>Rule Name</label>
        </div>
        <div class="field label border">
            <select name="action" id="edit-action">
                <option value="FILTER_COMPETENCY">Filter Competency</option>
                <option value="ESCALATE">Escalate</option>
                <option value="ASSIGN_TO_SHIFT">Assign to Shift</option>
                <option value="ASSIGN_TO_RADIOLOGIST">Assign to Radiologist</option>
                <option value="ASSIGN_TO_WORKLIST">Assign to Worklist</option>
            </select>
            <label>Action Type</label>
        </div>
        <div class="field label border">
            <input type="text" name="target" id="edit-target">
            <label>Action Target (ID, Shift ID, Worklist)</label>
        </div>

        <h6>Criteria</h6>
        <div class="field label border suffix">
            <select id="add-criteria-select-edit">
                <option value="" disabled selected>Select Criteria to Add</option>
                <option value="urgency">Exam Priority (Urgency)</option>
                <option value="site">Exam Site Code</option>
                <option value="ordering_physician">Referrer Details</option>
                <option value="patient_age_min">Patient Age (Min)</option>
                <option value="patient_age_max">Patient Age (Max)</option>
                <option value="procedure_code">Procedure Code</option>
                <option value="procedure_description">Procedure Description</option>
                <option value="prior_location">Prior Location</option>
                <option value="days_of_week">Days of Week (comma-sep)</option>
                <option value="technician">Technician</option>
                <option value="transcriptionist">Transcriptionist</option>
            </select>
            <label>Add Condition</label>
            <button type="button" onclick="addCriteria('edit')">Add</button>
        </div>
        <div id="criteria-container-edit"></div>

        <nav class="right-align">
            <button type="button" class="transparent link" onclick="ui('#edit-rule-modal')">Cancel</button>
            <button type="submit" class="primary">Update Rule</button>
        </nav>
    </form>
</dialog>

<script>
    const criteriaMap = {
        'urgency': 'Exam Priority (Urgency)',
        'site': 'Exam Site Code',
        'ordering_physician': 'Referrer Details',
        'patient_age_min': 'Patient Age (Min)',
        'patient_age_max': 'Patient Age (Max)',
        'procedure_code': 'Procedure Code',
        'procedure_description': 'Procedure Description',
        'prior_location': 'Prior Location',
        'days_of_week': 'Days of Week',
        'technician': 'Technician',
        'transcriptionist': 'Transcriptionist'
    };

    function addCriteriaInput(containerId, key, value) {
        const container = document.getElementById(containerId);
        const labelText = criteriaMap[key] || key;
        const inputName = 'filter_' + key;

        const div = document.createElement('div');
        div.className = 'field label border suffix';

        if (key === 'procedure_code') {
            const uniqueId = 'proc-' + Math.random().toString(36).substr(2, 9);
            const targetId = 'results-' + uniqueId;
            div.setAttribute('data-signals', JSON.stringify({procedureSearch: value || ''}));
            div.innerHTML = `
                <input type="text" data-bind-procedureSearch
                       data-on-input__debounce.200ms="@get('/active_search?type=procedure&target=${targetId}')"
                       value="${value}" placeholder="Search Procedure...">
                <label>${labelText}</label>
                <div id="${targetId}" class="active-search-results"></div>
                <input type="hidden" name="${inputName}" value="${value}">
                <a class="transparent circle" href="javascript:void(0)" onclick="this.parentElement.remove()"><i>close</i></a>
            `;
        } else {
            div.innerHTML = `
                <input type="text" name="${inputName}" value="${value}">
                <label>${labelText}</label>
                <a class="transparent circle" href="javascript:void(0)" onclick="this.parentElement.remove()"><i>close</i></a>
            `;
        }

        container.appendChild(div);
        ui();
    }

    function selectProcedure(el, code) {
        const wrapper = el.closest('[data-signals]');
        const searchInput = wrapper.querySelector('input[data-bind-procedureSearch]');
        const hiddenInput = wrapper.querySelector('input[type=hidden]');
        const results = wrapper.querySelector('.active-search-results');

        if (hiddenInput) {
             hiddenInput.value = code;
             if (searchInput) {
                 searchInput.value = code;
                 searchInput.dispatchEvent(new Event('input'));
             }
        }
        if (results) results.innerHTML = '';
    }

    function addCriteria(mode) {
        const selectId = 'add-criteria-select-' + mode;
        const containerId = 'criteria-container-' + mode;
        const select = document.getElementById(selectId);
        const key = select.value;
        if (!key) return;

        addCriteriaInput(containerId, key, '');
        select.value = "";
    }

    function openEditModal(id, name, action, target, filters) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-name').value = name;
        document.getElementById('edit-action').value = action;
        document.getElementById('edit-target').value = target || '';

        const container = document.getElementById('criteria-container-edit');
        container.innerHTML = '';

        if (filters) {
            for (const [key, value] of Object.entries(filters)) {
                let valStr = value;
                if (Array.isArray(value)) {
                    valStr = value.join(', ');
                }
                if (criteriaMap[key]) {
                    addCriteriaInput('criteria-container-edit', key, valStr);
                }
            }
        }

        ui('#edit-rule-modal');
        // Ensure open attribute is set for test visibility if ui() animation is slow or different
        document.getElementById('edit-rule-modal').setAttribute('open', '');
    }
</script>
{{ end }}
